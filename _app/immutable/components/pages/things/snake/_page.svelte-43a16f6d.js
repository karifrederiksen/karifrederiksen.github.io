var F=Object.defineProperty;var H=(e,t,n)=>t in e?F(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var _=(e,t,n)=>(H(e,typeof t!="symbol"?t+"":t,n),n);import{S as U,i as M,s as W,a as G,k as K,M as O,h as y,c as $,l as B,m as Y,n as x,b as v,B as R,o as V,O as X,Z as j}from"../../../../chunks/index-3155a5b5.js";var A=(e=>(e[e.Left=0]="Left",e[e.Up=1]="Up",e[e.Right=2]="Right",e[e.Down=3]="Down",e))(A||{}),l=(e=>(e[e.InProgress=0]="InProgress",e[e.InProgressAndPaused=1]="InProgressAndPaused",e[e.Lost=2]="Lost",e[e.Won=3]="Won",e))(l||{});function w(e){const[t,n]=e.gridSize,o=q(t,n);return{initArgs:e,state:0,gridSize:e.gridSize,grid:o,snake:{direction:e.dir,nextDirection:e.dir,nextNextDirection:null,length:e.snakeLength,position:e.position},noms:L(o,t,n)}}function L(e,t,n){const o=Math.floor(Math.random()*t),r=Math.floor(Math.random()*n);return e[o][r]>0?L(e,t,n):[o,r]}function q(e,t){const n=new Array(e);for(let o=0;o<e;o++){const r=new Array(t);for(let s=0;s<t;s++)r[s]=0;n[o]=r}return n}function Z(e){const t=J(e,e.snake.nextDirection);if(Q(e,t)){e.state=2;return}const[n,o]=t,{grid:r,snake:s,noms:i,gridSize:a}=e,[u,f]=a;if(s.position=[n,o],n===i[0]&&o===i[1])s.length++,r[n][o]=s.length,e.noms=L(r,u,f);else{for(let d=0;d<u;d++)for(let c=0;c<f;c++)r[d][c]>0&&r[d][c]--;r[n][o]=s.length}s.direction=s.nextDirection,s.nextDirection=s.nextNextDirection!==null?s.nextNextDirection:s.nextDirection,s.nextNextDirection=null}function J({grid:e,snake:t},n){const[o,r]=t.position;switch(n){case 0:return[o-1,r];case 1:return[o,r-1];case 2:return[o+1,r];case 3:return[o,r+1]}}function Q({grid:e,gridSize:[t,n]},[o,r]){return o>=t||o<0||r>=n||r<0||e[o][r]>1}function p({snake:e},t){e.direction===e.nextDirection?N(e.direction,t)&&(e.nextDirection=t):N(e.nextDirection,t)&&(e.nextNextDirection=t)}function N(e,t){switch(e){case 0:return t!==2;case 2:return t!==0;case 1:return t!==3;case 3:return t!==1}}function I({snake:e,initArgs:t}){return e.length-t.snakeLength}function ee(e,t,n){const o=k(e,t,WebGLRenderingContext.VERTEX_SHADER),r=k(e,n,WebGLRenderingContext.FRAGMENT_SHADER);if(o===null||r===null)return null;const s=e.createProgram();if(s===null)return console.error("Failed to create program"),null;e.attachShader(s,o),e.attachShader(s,r);const i=te(e,s);return e.deleteShader(o),e.deleteShader(r),i}function k(e,t,n){const o=e.createShader(n);if(o===null)return console.error("Failed to create shader."),null;if(e.shaderSource(o,t),e.compileShader(o),e.getShaderParameter(o,WebGLRenderingContext.COMPILE_STATUS))return o;console.group("Failed to compile shader"),console.error("shader info log: ",e.getShaderInfoLog(o));const r=ne(t);return console.log(r),console.groupEnd(),e.deleteShader(o),null}function te(e,t){return e.linkProgram(t),t!==null||e.getProgramParameter(t,WebGLRenderingContext.LINK_STATUS)?t:(console.group("Failed to link program"),console.error("error: ",e.getError()),console.log("validate status: ",e.getProgramParameter(t,WebGLRenderingContext.VALIDATE_STATUS)),console.log("program info log: ",e.getProgramInfoLog(t)),console.groupEnd(),e.deleteProgram(t),null)}function ne(e){const t=e.split(`
`),n=t.length.toString().length;return t.map((o,r)=>oe(r.toString(10),n,"0")+"| "+o).join(`
`)}function oe(e,t,n){const o=t-e.length;if(o<=0)return e;const r=[];for(let s=0;s<o;s++)r.push(n);return r.push(e),r.join("")}const E=5,re=`
precision highp float;

attribute vec2 a_position;
attribute vec3 a_color;

uniform vec2 canvas_resolution;

varying vec3 v_color;

void main() {
    vec2 pos = (a_position / canvas_resolution) * vec2(2.0, -2.0) + vec2(-1.0, 1.0);
    gl_Position = vec4(pos, 0.0, 1.0);
    v_color = a_color;
}
`,se=`
precision highp float;

varying vec3 v_color;

void main() {
    gl_FragColor = vec4(v_color, 1.0);
}
`;class ie{constructor(t,n,o){_(this,"program");_(this,"buf");_(this,"array");_(this,"sizeUniform");_(this,"blockSize");this.gl=t,this.canvasSize=n,this.gridSize=o,this.blockSize=[Math.ceil(n[0]/o[0]),Math.ceil(n[1]/o[1])],this.program=ee(t,re,se);const r=o[0]*o[1];this.buf=t.createBuffer(),this.array=new Float32Array(r*6*E),this.sizeUniform=t.getUniformLocation(this.program,"canvas_resolution"),t.useProgram(this.program),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.bindAttribLocation(this.program,0,"a_position"),t.bindAttribLocation(this.program,1,"a_color")}bufferGrid(t){const{array:n,gridSize:o,blockSize:r}=this,[s,i]=r;let a=0;for(let u=0;u<o[1];u++){const f=u*i,d=f+i;for(let c=0;c<o[0];c++){const S=c*s,m=S+s,{r:h,g,b}=t(c,u);n[a++]=S,n[a++]=f,n[a++]=h,n[a++]=g,n[a++]=b,n[a++]=S,n[a++]=d,n[a++]=h,n[a++]=g,n[a++]=b,n[a++]=m,n[a++]=f,n[a++]=h,n[a++]=g,n[a++]=b,n[a++]=m,n[a++]=d,n[a++]=h,n[a++]=g,n[a++]=b,n[a++]=S,n[a++]=d,n[a++]=h,n[a++]=g,n[a++]=b,n[a++]=m,n[a++]=f,n[a++]=h,n[a++]=g,n[a++]=b}}}setColor(t,n,{r:o,g:r,b:s}){const{array:i,gridSize:a,blockSize:u}=this,[f,d]=u;let c=(a[0]*n+t)*6*E;const S=n*d,m=S+d,h=t*f,g=h+f;i[c++]=h,i[c++]=S,i[c++]=o,i[c++]=r,i[c++]=s,i[c++]=h,i[c++]=m,i[c++]=o,i[c++]=r,i[c++]=s,i[c++]=g,i[c++]=S,i[c++]=o,i[c++]=r,i[c++]=s,i[c++]=g,i[c++]=m,i[c++]=o,i[c++]=r,i[c++]=s,i[c++]=h,i[c++]=m,i[c++]=o,i[c++]=r,i[c++]=s,i[c++]=g,i[c++]=S,i[c++]=o,i[c++]=r,i[c++]=s}flush(){const{gl:t,canvasSize:n,gridSize:o}=this,r=o[0]*o[1];t.bindBuffer(t.ARRAY_BUFFER,this.buf),t.bufferData(t.ARRAY_BUFFER,this.array,t.DYNAMIC_DRAW),t.uniform2f(this.sizeUniform,n[0],n[1]);const s=E*4;t.vertexAttribPointer(0,2,t.FLOAT,!1,s,0),t.vertexAttribPointer(1,3,t.FLOAT,!1,s,8),t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.drawArrays(t.TRIANGLES,0,r*6)}}const ce=100,ae=20,le=20,ue=4,de=A.Right,he=1,fe=1;class T{constructor(t){_(this,"_content");_(this,"_color");var n;this.elem=t,this._content=(n=t.textContent)!=null?n:"",this._color=t.style.color}content(t){this._content!==t&&(this._content=t,this.elem.textContent=t)}color(t){this._color!==t&&(this._color=t,this.elem.style.color=t)}}function D(e,t){e.before(t),t.style.position="absolute",t.style.width=e.width+"px",t.style.height=e.height+"px"}function ge(e,t){const n=e.getContext("webgl2",{desynchronized:!0});if(n==null)return null;const o={config:t,game:w({gridSize:[ae,le],dir:de,snakeLength:ue,position:[he,fe]}),needsRender:!0,highScore:t.getHighScore(),statusContainer:new T(document.createElement("div")),scoreContainer:new T(document.createElement("div"))};e.before(o.scoreContainer.elem),e.before(o.statusContainer.elem),D(e,o.scoreContainer.elem),o.scoreContainer.elem.style.fontSize="28px",o.scoreContainer.elem.style.color="rgb(0, 235, 255)",o.scoreContainer.elem.style.padding="16px 0px 0px 16px",D(e,o.statusContainer.elem),o.scoreContainer.elem.style.fontSize="28px",o.statusContainer.elem.style.font="72px Roboto",o.statusContainer.elem.style.textAlign="center",o.statusContainer.elem.style.verticalAlign="middle";const r=new ie(n,[e.width,e.height],o.game.gridSize),s=u=>{Ie(o,u)&&(u.preventDefault(),u.stopPropagation())};window.addEventListener("keydown",s);const i={cancelled:!1};z(i,r,o);const a=setInterval(()=>pe(o),ce);return{stop(){window.removeEventListener("keydown",s),clearInterval(a),i.cancelled=!0,o.scoreContainer.elem.remove(),o.statusContainer.elem.remove(),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT)}}}function z(e,t,n){e.cancelled||(Se(t,n),requestAnimationFrame(()=>z(e,t,n)))}function Se(e,t){const n=performance.now();t.needsRender&&(t.game.state===l.InProgress&&Ce(e,t.game),t.needsRender=!1),be(e,t.game,n),e.flush(),_e(t),ye(t)}function _e(e){switch(e.game.state){case l.InProgress:e.statusContainer.content("");break;case l.InProgressAndPaused:e.statusContainer.content("Paused"),e.statusContainer.color("rgb(240, 20, 20)");break;case l.Lost:e.statusContainer.content("You died"),e.statusContainer.color("rgb(255, 0, 0)");break;case l.Won:e.statusContainer.content("You won?"),e.statusContainer.color("rgb(255, 0, 0)");break}}function C(e,t,n){return t+e*(n-t)}function me(e){return{r:C(e,.6,.8),g:C(e,.6,1),b:C(e,.5,.4)}}function be(e,t,n){const[o,r]=t.noms;e.setColor(o,r,Ae(n))}function Ae(e){const t=e%100/100;return{r:1,g:e%200/200,b:t}}function Ce(e,t){e.bufferGrid((n,o)=>{const r=t.grid[n][o];if(r>0){if(r==t.snake.length)return{r:1,g:1,b:1};const s=t.grid[n][o]/t.snake.length;return me(s)}return{r:0,g:0,b:0}})}function ye(e){const t=I(e.game),n=e.game.gridSize[0]*e.game.gridSize[1],o=t/n;e.highScore===null?e.scoreContainer.content(I(e.game).toString()):e.scoreContainer.content(`${I(e.game)} | ${e.highScore}`);const r=Math.round(C(o,0,255)),s=Math.round(C(o,255,0));e.scoreContainer.color(`rgb(${r}, 255, ${s})`)}function pe(e){var n;const t=e.game;switch(t.state){case l.InProgress:Z(t),e.needsRender=!0;break;case l.Won:case l.Lost:{const o=I(t);o>((n=e.highScore)!=null?n:0)&&e.config.setHighScore(o);break}}}function Ie(e,t){const n=t.code;switch(e.game.state){case l.InProgress:return Re(e,n);case l.InProgressAndPaused:return Ee(e,n);case l.Lost:case l.Won:return xe(e,n)}}function xe(e,t){switch(t){case"Enter":case"Escape":case"Space":return e.game=w(e.game.initArgs),e.needsRender=!0,e.highScore=e.config.getHighScore(),!0;default:return!1}}function Re(e,t){const n=e.game;switch(t){case"Enter":case"Escape":case"Space":return n.state=l.InProgressAndPaused,e.needsRender=!0,!0;case"ArrowLeft":case"KeyA":return p(n,A.Left),!0;case"ArrowUp":case"KeyW":return p(n,A.Up),!0;case"ArrowRight":case"KeyD":return p(n,A.Right),!0;case"ArrowDown":case"KeyS":return p(n,A.Down),!0;default:return!1}}function Ee({game:e},t){switch(t){case"Enter":case"Escape":case"Space":return e.state=l.InProgress,!0;default:return!1}}const P="Snake | high score";function Pe(){var e;try{const t=Number((e=localStorage.getItem(P))!=null?e:"NaN");return Number.isNaN(t)?null:t}catch{return null}}function Le(e){try{localStorage.setItem(P,e.toString())}catch{console.error(`Failed to set: ${P}`)}}function ve(e){let t,n;return{c(){t=G(),n=K("canvas"),this.h()},l(o){O("svelte-1692esp",document.head).forEach(y),t=$(o),n=B(o,"CANVAS",{width:!0,height:!0,class:!0}),Y(n).forEach(y),this.h()},h(){document.title="Snake",x(n,"width","800"),x(n,"height","800"),x(n,"class","svelte-owbo5l")},m(o,r){v(o,t,r),v(o,n,r),e[1](n)},p:R,i:R,o:R,d(o){o&&y(t),o&&y(n),e[1](null)}}}function Ne(e,t,n){let o,r;V(()=>{o&&(r=ge(o,{getHighScore:Pe,setHighScore:Le}))}),X(()=>{r==null||r.stop()});function s(i){j[i?"unshift":"push"](()=>{o=i,n(0,o)})}return[o,s]}class De extends U{constructor(t){super(),M(this,t,Ne,ve,W,{})}}export{De as default};
